<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel LIFEPAR - Entrenadores</title>
  <link rel="stylesheet" href="admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Quicksand:wght@400;600&family=Dancing+Script&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="#">
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
  </div>
  <nav class="nav-lateral">
    <div class="menu-seccion">
      <a href="javascript:void(0)" class="nav-item" onclick="toggleArbol('arbol-zonas')">
        📊 <span>ZONAS</span> <span class="flecha" id="flecha-zonas">▾</span>
      </a>
      <div id="arbol-zonas" class="submenu-lista">
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(1)">ZONA 1</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(2)">ZONA 2</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(3)">ZONA 3</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(4)">ZONA 4</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(5)">ZONA 5</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(6)">ZONA 6</a>
      </div>
    </div>
    
  <div class="menu-seccion">
  <a href="javascript:void(0)" class="nav-item" onclick="toggleArbol('arbol-seguros')">
    🛡️ <span>SEGUROS</span> <span class="flecha" id="flecha-seguros">▾</span>
  </a>
  <div id="arbol-seguros" class="submenu-lista">
    <a href="https://forms.gle/qZJS945CVCF6spgA9" target="_blank">➕ Cargar seguro nuevo</a>
    <a href="docs/declaracion_jurada.pdf" target="_blank">📄 Descargar declaración</a>
    <a href="docs/info_seguro.pdf" target="_blank">📘 Ver información</a>
  </div>
</div>

<div class="menu-seccion">
    <a href="https://drive.google.com/drive/folders/1jeKMSZhLfi_oS9Yz-YNg46qQ4Kw-la25?usp=drive_link" target="_blank" class="nav-item">
      📜 <span>REGLAMENTOS</span>
    </a>
  </div>

  <div class="menu-seccion">
    <a href="https://drive.google.com/drive/folders/1QCHBw0will7Lhi13W2hy9M5K74GP8JRE?usp=drive_link" target="_blank" class="nav-item">
      🚀 <span>PROYECTO 2026</span>
    </a>
  </div>

  <div class="menu-seccion">
    <a href="javascript:void(0)" class="nav-item" onclick="mostrarCopa()">
      🏆 <span>COPA OPEN FEDERAL</span>
    </a>
  </div>
</nav>
</aside>

<div class="zona-derecha" id="main-content">
  
  <header class="header-admin">
    <div class="logo">
      <img src="img/logo.png" alt="Logo LIFEPAR" class="logo-img" />
      <div class="texto-logo">
        <h1>LIFEPAR</h1>
        <span class="slogan">es una realidad</span>
      </div>
    </div>
    <nav>
      <ul class="nav-buttons">
        <li><a href="index.html" class="btn-pildora-nav">IR A LA WEB</a></li>
        <li><button onclick="logout()" class="btn-cerrar-sesion">CERRAR SESIÓN</button></li>
      </ul>
    </nav>
  </header>

  <div class="header-spacer"></div>

  <main class="contenedor-principal">
    <div class="bienvenida-seccion">
        <h2>Panel de Entrenadores <span class="frase-fina">Bienvenido a tu oficina virtual</span></h2>
 <div style="text-align: right; padding: 15px; font-family: 'Quicksand', sans-serif;">
    <span id="display-name" style="font-weight: bold; font-size: 1.2rem; color: #333;">Cargando...</span><br>
    <span id="display-email" style="font-size: 0.9rem; color: #666;"></span>
 </div>
</section>

<section id="contenedor-acciones-zonas" style="display: none; margin-top: 20px; width: 100%;">
            </section>
      
    <section class="box-oficina" id="seguros" style="display: none;">
        <h3>Gestión de Seguros</h3>
        <div class="lista-links">
            <a href="https://forms.gle/qZJS945CVCF6spgA9" target="_blank" class="btn-link-fino">➕ Cargar seguro nuevo</a>
            <a href="docs/declaracion_jurada.pdf" target="_blank" class="btn-link-fino">📄 Descargar declaración</a>
            <a href="docs/info_seguro.pdf" target="_blank" class="btn-link-fino">📘 Información general</a>
        </div>
    </section>

    <section class="box-oficina" id="copa-federal" style="display: none;">
        <h3>Open Copa Federal</h3>
        <div class="lista-links">
            <a href="#" target="_blank" class="btn-link-fino">📄 Ver PDF del evento</a>
            <a href="#" target="_blank" class="btn-link-fino">📝 Formulario inscripción</a>
        </div>
    </section>
    </main> 

    <footer class="footer-premium">
    <p>© 2026 <span class="brand">LIFEPAR</span> - Todos los derechos reservados</p>
    <div class="footer-contact">
        <a href="https://instagram.com/ligalifepar" target="_blank">📸 @ligalifepar</a>
        <a href="https://wa.me/541158512121" target="_blank">📱 11-5851-2121</a>
    </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDOwn0QlyqdU3fDBEsPFuvPMzs4ylqMuQ8",
    authDomain: "web-lifepar.firebaseapp.com",
    databaseURL: "https://web-lifepar-default-rtdb.firebaseio.com",
    projectId: "web-lifepar",
    storageBucket: "web-lifepar.firebasestorage.app",
    messagingSenderId: "140850288146",
    appId: "1:140850288146:web:fe1d35bac4c30c39b3aacb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Exponemos la función al objeto window para que el iframe la vea
  window.registrarClubEnFirebase = async (emailKey, clubKey) => {
    const clubRef = ref(db, `CLUBES/${emailKey}/${clubKey}`);
    return await set(clubRef, {
      nombre: clubKey.replace(/_/g, ' '),
      estado: "pendiente",
      fecha: new Date().toLocaleDateString()
    });
  };

  window.obtenerClubesFirebase = async (emailKey) => {
    const { getDatabase, ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    const snapshot = await get(ref(db, `CLUBES/${emailKey}`));
    if (snapshot.exists()) {
        return snapshot.val(); // Retorna el objeto con todos los clubes del profe
    }
    return null;
};
  // Dentro del script type="module" del HTML principal
window.guardarPatinadorFirebase = async (numZona, datos) => {
    const { getDatabase, ref, push } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    
    // Creamos la ruta ZONAS/ZONA_1, ZONAS/ZONA_2, etc.
    const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
    
    // Usamos push para que cada patinador tenga un ID único y no se pisen
    return await push(zonaRef, {
        ...datos,
        fecha_registro: new Date().toISOString()
    });
};

// --- PUENTE DE ALTA PRIORIDAD PARA EL HIJO ---

window.obtenerPatinadoresPorClub = async (numZona, mailProfe) => {
    try {
        const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
        // Usamos la 'db' que ya inicializaste al principio del script
        const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
        const consulta = query(zonaRef, orderByChild("mailProfe"), equalTo(mailProfe));
        const snapshot = await get(consulta);
        
        return snapshot.exists() ? snapshot.val() : {};
    } catch (error) {
        console.error("Error en Puente Padre:", error);
        return null;
    }
};

// FUNCIÓN 2: Guarda el tilde de F2, F3 o F4 al instante
window.actualizarAsistencia = async (numZona, idPatinador, campoFecha, estado) => {
    const { getDatabase, ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    const updates = {};
    updates[`ZONAS/ZONA_${numZona}/${idPatinador}/${campoFecha}`] = estado;
    
    return update(ref(db), updates);
};

window.mostrarListadoAltas = async (numZona) => {
    const mailProfe = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
    const contenedor = document.getElementById('contenedor-acciones-zonas');
    
    contenedor.style.display = 'block';
    contenedor.innerHTML = '<p style="color:gold; text-align:center;">⏳ Cargando Tarjetas...</p>';

    try {
        const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
        const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
        const consulta = query(zonaRef, orderByChild("mailProfe"), equalTo(mailProfe));
        const snapshot = await get(consulta);

        if (!snapshot.exists()) {
            contenedor.innerHTML = '<p style="color:white; text-align:center;">No hay patinadores en la Zona ' + numZona + '</p>';
            return;
        }

        let html = `
        <style>
            .grid-altas { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 15px; padding: 10px; }
            .card-alta { background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 12px; padding: 15px; position: relative; }
            .card-alta:hover { border-color: gold; box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); }
            .card-alta h3 { color: gold; font-family: 'Anton'; font-size: 1.1rem; margin-bottom: 5px; text-transform: uppercase; }
            .card-alta p { color: #ccc; font-size: 0.85rem; margin-bottom: 12px; font-family: 'Quicksand'; }
            .controles-f { display: flex; justify-content: space-between; border-top: 1px solid #222; padding-top: 10px; }
            .btn-check { background: #222; border: 1px solid #444; color: #777; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 1; margin: 0 3px; font-size: 0.75rem; transition: 0.2s; }
            .btn-check.activo { background: #28a745; color: white; border-color: #28a745; box-shadow: 0 0 8px rgba(40, 167, 69, 0.4); }
        </style>
        <h3 style="color:gold; font-family:'Anton'; margin-bottom:15px; text-align:center;">PADRÓN ZONA ${numZona}</h3>
        <div class="grid-altas">`;

        snapshot.forEach((hijo) => {
            const p = hijo.val();
            const id = hijo.key;
            html += `
                <div class="card-alta">
                    <h3>${p.apellido}, ${p.nombre}</h3>
                    <p>${p.categoria}</p>
                    <div class="controles-f">
                        <button class="btn-check ${p.asisteF2 ? 'activo' : ''}" onclick="window.toggleBotonAsistencia('${numZona}','${id}','asisteF2',this)">F2</button>
                        <button class="btn-check ${p.asisteF3 ? 'activo' : ''}" onclick="window.toggleBotonAsistencia('${numZona}','${id}','asisteF3',this)">F3</button>
                        <button class="btn-check ${p.asisteF4 ? 'activo' : ''}" onclick="window.toggleBotonAsistencia('${numZona}','${id}','asisteF4',this)">F4</button>
                    </div>
                </div>`;
        });

        html += `</div>
                 <button onclick="document.getElementById('contenedor-acciones-zonas').style.display='none'" style="margin-top:20px; width:100%; background:gold; border:none; padding:12px; font-weight:bold; cursor:pointer; border-radius:8px; color:black;">CERRAR PANEL</button>`;
        
        contenedor.innerHTML = html;
    } catch (e) {
        contenedor.innerHTML = '<p style="color:red;">Error al cargar datos.</p>';
    }
};

window.toggleBotonAsistencia = async (numZona, id, campo, boton) => {
    const nuevoEstado = !boton.classList.contains('activo');
    try {
        await window.actualizarAsistencia(numZona, id, campo, nuevoEstado);
        boton.classList.toggle('activo');
    } catch (e) {
        alert("Error al guardar");
    }
};
</script>
<script src="admin.js"></script>
</body>
</html>
