<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel LIFEPAR - Entrenadores</title>
  <link rel="stylesheet" href="admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Quicksand:wght@400;600&family=Dancing+Script&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="#">
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
  </div>
  <nav class="nav-lateral">
    <div class="menu-seccion">
      <a href="javascript:void(0)" class="nav-item" onclick="toggleArbol('arbol-zonas')">
        📊 <span>ZONAS</span> <span class="flecha" id="flecha-zonas">▾</span>
      </a>
      <div id="arbol-zonas" class="submenu-lista">
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(1)">ZONA 1</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(2)">ZONA 2</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(3)">ZONA 3</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(4)">ZONA 4</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(5)">ZONA 5</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(6)">ZONA 6</a>
      </div>
    </div>

<div class="menu-item">
    <button class="menu-btn" onclick="toggleArbol('submenu-clinicas')">
        <i class="fas fa-skating"></i> INSCRIPCIÓN CLÍNICAS
    </button>
    <div id="submenu-clinicas" class="submenu-lista" style="display: none;">
        
        <div class="menu-item-nested">
    <button class="menu-btn-nested" onclick="toggleArbol('clinicas-feb')">
        CLÍNICAS FEBRERO
    </button>
    <div id="clinicas-feb" class="submenu-lista" style="display: none; padding-left: 20px;">
        <a href="javascript:void(0)" onclick="activarSeccionClinica('feb-1-3')">ZONA 1 Y 3</a>
        <a href="javascript:void(0)" onclick="activarSeccionClinica('feb-2-4')">ZONA 2 Y 4</a>
        <a href="javascript:void(0)" onclick="activarSeccionClinica('feb-5-6')">ZONA 5 Y 6</a>
    </div>
</div>

<div class="menu-item-nested">
    <button class="menu-btn-nested" onclick="toggleArbol('clinicas-mar')">
        CLÍNICAS MARZO
    </button>
    <div id="clinicas-mar" class="submenu-lista" style="display: none; padding-left: 20px;">
        <a href="javascript:void(0)" onclick="activarSeccionClinica('mar-1-3')">ZONA 1 Y 3</a>
        <a href="javascript:void(0)" onclick="activarSeccionClinica('mar-2-4')">ZONA 2 Y 4</a>
        <a href="javascript:void(0)" onclick="activarSeccionClinica('mar-5-6')">ZONA 5 Y 6</a>
    </div>
</div>

    </div>
</div>
    
  <div class="menu-seccion">
  <a href="javascript:void(0)" class="nav-item" onclick="toggleArbol('arbol-seguros')">
    🛡️ <span>SEGUROS</span> <span class="flecha" id="flecha-seguros">▾</span>
  </a>
  <div id="arbol-seguros" class="submenu-lista">
    <a href="https://forms.gle/qZJS945CVCF6spgA9" target="_blank">➕ Cargar seguro nuevo</a>
    <a href="docs/declaracion_jurada.pdf" target="_blank">📄 Descargar declaración</a>
    <a href="docs/info_seguro.pdf" target="_blank">📘 Ver información</a>
  </div>
</div>

<div class="menu-seccion">
    <a href="https://drive.google.com/drive/folders/1jeKMSZhLfi_oS9Yz-YNg46qQ4Kw-la25?usp=drive_link" target="_blank" class="nav-item">
      📜 <span>REGLAMENTOS</span>
    </a>
  </div>

  <div class="menu-seccion">
    <a href="https://drive.google.com/drive/folders/1QCHBw0will7Lhi13W2hy9M5K74GP8JRE?usp=drive_link" target="_blank" class="nav-item">
      🚀 <span>PROYECTO 2026</span>
    </a>
  </div>

  <div class="menu-seccion">
    <a href="javascript:void(0)" class="nav-item" onclick="mostrarCopa()">
      🏆 <span>COPA OPEN FEDERAL</span>
    </a>
  </div>
</nav>
</aside>

<div class="zona-derecha" id="main-content">
  
  <header class="header-admin">
    <div class="logo">
      <img src="img/logo.png" alt="Logo LIFEPAR" class="logo-img" />
      <div class="texto-logo">
        <h1>LIFEPAR</h1>
        <span class="slogan">es una realidad</span>
      </div>
    </div>
    <nav>
      <ul class="nav-buttons">
        <li><a href="index.html" class="btn-pildora-nav">IR A LA WEB</a></li>
        <li><button onclick="logout()" class="btn-cerrar-sesion">CERRAR SESIÓN</button></li>
      </ul>
    </nav>
  </header>

  <div class="header-spacer"></div>

  <main class="contenedor-principal">
    <div class="bienvenida-seccion">
        <h2>Panel de Entrenadores <span class="frase-fina">Bienvenido a tu oficina virtual</span></h2>
 <div style="text-align: right; padding: 15px; font-family: 'Quicksand', sans-serif;">
    <span id="display-name" style="font-weight: bold; font-size: 1.2rem; color: #333;">Cargando...</span><br>
    <span id="display-email" style="font-size: 0.9rem; color: #666;"></span>
 </div>
</section>

<section id="contenedor-acciones-zonas" style="display: none; margin-top: 20px; width: 100%;">
        <div id="contenedor-clinicas" style="display: none; padding: 20px; background: #111; border: 2px solid gold; margin-top: 20px;">
    <h3 id="titulo-clinica" style="color: gold; text-align: center; text-transform: uppercase;"></h3>
    
    <div style="margin-bottom: 15px;">
        <label style="color: white; display: block; margin-bottom: 5px;">Seleccionar Club:</label>
        <select id="select-club-clinica" style="padding: 8px; width: 100%; background: #222; color: white; border: 1px solid gold;"></select>
    </div>

    <table style="width: 100%; border-collapse: collapse; color: white; background: #222;">
        <thead>
            <tr style="background: #333; color: gold;">
                <th style="border: 1px solid #444; padding: 8px; width: 40px;">#</th>
                <th style="border: 1px solid #444; padding: 8px;">Nombre y Apellido</th>
                <th style="border: 1px solid #444; padding: 8px;">Categoría</th>
                <th style="border: 1px solid #444; padding: 8px; width: 60px;">Edad</th>
            </tr>
        </thead>
        <tbody id="body-tabla-clinica">
            </tbody>
    </table>

    <button onclick="enviarInscripcionClinica()" style="margin-top: 20px; padding: 12px; background: linear-gradient(to right, gold, #b8860b); color: black; font-weight: bold; cursor: pointer; border: none; width: 100%; border-radius: 4px;">
        🚀 ENVIAR INSCRIPCIÓN FINAL
    </button>
</div>
            </section>
      
    <section class="box-oficina" id="seguros" style="display: none;">
        <h3>Gestión de Seguros</h3>
        <div class="lista-links">
            <a href="https://forms.gle/qZJS945CVCF6spgA9" target="_blank" class="btn-link-fino">➕ Cargar seguro nuevo</a>
            <a href="docs/declaracion_jurada.pdf" target="_blank" class="btn-link-fino">📄 Descargar declaración</a>
            <a href="docs/info_seguro.pdf" target="_blank" class="btn-link-fino">📘 Información general</a>
        </div>
    </section>

    <section class="box-oficina" id="copa-federal" style="display: none;">
        <h3>Open Copa Federal</h3>
        <div class="lista-links">
            <a href="#" target="_blank" class="btn-link-fino">📄 Ver PDF del evento</a>
            <a href="#" target="_blank" class="btn-link-fino">📝 Formulario inscripción</a>
        </div>
    </section>
    </main> 

    <footer class="footer-premium">
    <p>© 2026 <span class="brand">LIFEPAR</span> - Todos los derechos reservados</p>
    <div class="footer-contact">
        <a href="https://instagram.com/ligalifepar" target="_blank">📸 @ligalifepar</a>
        <a href="https://wa.me/541158512121" target="_blank">📱 11-5851-2121</a>
    </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDOwn0QlyqdU3fDBEsPFuvPMzs4ylqMuQ8",
    authDomain: "web-lifepar.firebaseapp.com",
    databaseURL: "https://web-lifepar-default-rtdb.firebaseio.com",
    projectId: "web-lifepar",
    storageBucket: "web-lifepar.firebasestorage.app",
    messagingSenderId: "140850288146",
    appId: "1:140850288146:web:fe1d35bac4c30c39b3aacb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let clinicaActiva = "";

  // --- NUEVAS FUNCIONES INTEGRADAS ---

  window.cargarZona = function(idClinica) {
    const contenedor = document.getElementById('contenedor-clinicas');
    if (!contenedor) return;

    contenedor.style.display = 'block';
    clinicaActiva = idClinica;
    
    const titulo = document.getElementById('titulo-clinica');
    if (titulo) titulo.innerText = "Inscripción: " + idClinica.replace(/-/g, ' ');

    cargarClubes('select-club-clinica'); 

    const tbody = document.getElementById('body-tabla-clinica');
    if (tbody) {
        tbody.innerHTML = ""; 
        for (let i = 1; i <= 20; i++) {
            tbody.innerHTML += `
                <tr>
                    <td style="border: 1px solid #444; text-align: center; padding: 5px; color: gold;">${i}</td>
                    <td style="border: 1px solid #444;"><input type="text" class="input-tabla nombre" style="width: 95%; background: transparent; color: white; border: none; padding: 5px;"></td>
                    <td style="border: 1px solid #444;"><input type="text" class="input-tabla categoria" style="width: 95%; background: transparent; color: white; border: none; padding: 5px;"></td>
                    <td style="border: 1px solid #444;"><input type="number" class="input-tabla edad" style="width: 95%; background: transparent; color: white; border: none; padding: 5px;"></td>
                </tr>`;
        }
    }
  };

  async function cargarClubes(idSelect) {
    const select = document.getElementById(idSelect);
    if (!select) return;
    const mailProfe = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
    const clubes = await window.obtenerClubesFirebase(mailProfe.replace(/\./g, '_'));
    if (clubes) {
        select.innerHTML = '<option value="">Seleccioná un club...</option>';
        Object.keys(clubes).forEach(id => {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = clubes[id].nombre;
            select.appendChild(option);
        });
    }
  }

  window.activarSeccionClinica = (idClinica) => {
    const contenedorGral = document.getElementById('contenedor-acciones-zonas');
    if (contenedorGral) contenedorGral.style.display = 'block';
    window.cargarZona(idClinica);
  };

  window.enviarInscripcionClinica = async () => {
    const selectClub = document.getElementById('select-club-clinica');
    const clubSeleccionado = selectClub.value;
    if (!clubSeleccionado) return alert("Seleccioná un club.");

    const filas = document.querySelectorAll('#body-tabla-clinica tr');
    const lista = [];
    filas.forEach(f => {
        const n = f.querySelector('.nombre').value.trim();
        if (n) lista.push({ nombre: n, cat: f.querySelector('.categoria').value, edad: f.querySelector('.edad').value });
    });

    if (lista.length === 0) return alert("Ingresá al menos un patinador.");
try {
        await window.guardarInscripcionClinicaFirebase(clinicaActiva, clubSeleccionado, lista);
        alert("¡Enviado con éxito!");

        // --- LÓGICA DE LIMPIEZA ---
        
        // 1. Limpiar todos los inputs de la tabla (nombre, categoría, edad)
        const inputs = document.querySelectorAll('#body-tabla-clinica input');
        inputs.forEach(input => input.value = "");

        // 2. Resetear el selector de clubes a la opción inicial
        const selectClub = document.getElementById('select-club-clinica');
        if (selectClub) selectClub.value = "";

        // 3. Opcional: Volver el scroll al inicio de la tabla
        document.getElementById('contenedor-clinicas').scrollTop = 0;

    } catch (e) { 
        alert("Error al guardar."); 
    }
  };
  window.guardarInscripcionClinicaFirebase = async (idClinica, club, listaInscriptos) => {
    try {
        const { ref, set } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
        
        // Reemplazamos puntos por guiones bajos para evitar errores de ruta
        const nombreClubLimpio = club.replace(/\./g, '_');
        
        // RUTA: INSCRIPCIONES_CLINICAS / feb-1-3 / Nombre_Del_Club
        const clinicaRef = ref(db, `INSCRIPCIONES_CLINICAS/${idClinica}/${nombreClubLimpio}`);
        
        return await set(clinicaRef, {
            lista: listaInscriptos,
            fecha_registro: new Date().toLocaleString(),
            ultimo_cambio: new Date().toISOString(),
            id_clinica: idClinica,
            club: club
        });
    } catch (error) {
        throw error;
    }
};

  // Exponemos la función al objeto window para que el iframe la vea
  window.registrarClubEnFirebase = async (emailKey, clubKey) => {
    const clubRef = ref(db, `CLUBES/${emailKey}/${clubKey}`);
    return await set(clubRef, {
      nombre: clubKey.replace(/_/g, ' '),
      estado: "pendiente",
      fecha: new Date().toLocaleDateString()
    });
  };

  window.obtenerClubesFirebase = async (emailKey) => {
    const { getDatabase, ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    const snapshot = await get(ref(db, `CLUBES/${emailKey}`));
    if (snapshot.exists()) {
        return snapshot.val(); // Retorna el objeto con todos los clubes del profe
    }
    return null;
};
  // Dentro del script type="module" del HTML principal
window.guardarPatinadorFirebase = async (numZona, datos) => {
    const { getDatabase, ref, push } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    
    // Creamos la ruta ZONAS/ZONA_1, ZONAS/ZONA_2, etc.
    const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
    
    // Usamos push para que cada patinador tenga un ID único y no se pisen
    return await push(zonaRef, {
        ...datos,
        fecha_registro: new Date().toISOString()
    });
};

// --- PUENTE DE ALTA PRIORIDAD PARA EL HIJO ---

window.obtenerPatinadoresPorClub = async (numZona, mailProfe) => {
    try {
        const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
        // Usamos la 'db' que ya inicializaste al principio del script
        const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
        const consulta = query(zonaRef, orderByChild("mailProfe"), equalTo(mailProfe));
        const snapshot = await get(consulta);
        
        return snapshot.exists() ? snapshot.val() : {};
    } catch (error) {
        console.error("Error en Puente Padre:", error);
        return null;
    }
};

// EL PADRE SOLO CONECTA Y GRABA
window.actualizarAsistencia = async (numZona, id, campo, nuevoEstado) => {
    const { ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const patinadorRef = ref(db, `ZONAS/ZONA_${numZona}/${id}`);
    await update(patinadorRef, { [campo]: nuevoEstado });
};

// El Padre solo le "presta" Firebase al hijo cuando este lo pide
window.obtenerDatosFirebase = async (numZona, mailProfe) => {
    const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
    let consulta = query(zonaRef, orderByChild("mailProfe"), equalTo(mailProfe));
    
    return await get(consulta);
};

</script>
<script src="admin.js"></script>
</body>
</html>
