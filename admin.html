<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panel LIFEPAR - Entrenadores</title>
  <link rel="stylesheet" href="admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Anton&family=Quicksand:wght@400;600&family=Dancing+Script&display=swap" rel="stylesheet">
  <link rel="shortcut icon" href="#">
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <button class="toggle-btn" onclick="toggleSidebar()">☰</button>
  </div>
  <nav class="nav-lateral">
    <div class="menu-seccion">
      <a href="javascript:void(0)" class="nav-item" onclick="toggleArbol('arbol-zonas')">
        📊 <span>ZONAS</span> <span class="flecha" id="flecha-zonas">▾</span>
      </a>
      <div id="arbol-zonas" class="submenu-lista">
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(1)">ZONA 1</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(2)">ZONA 2</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(3)">ZONA 3</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(4)">ZONA 4</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(5)">ZONA 5</a>
        <a href="javascript:void(0)" onclick="mostrarAccionesZona(6)">ZONA 6</a>
      </div>
    </div>
    
  <div class="menu-seccion">
  <a href="javascript:void(0)" class="nav-item" onclick="toggleArbol('arbol-seguros')">
    🛡️ <span>SEGUROS</span> <span class="flecha" id="flecha-seguros">▾</span>
  </a>
  <div id="arbol-seguros" class="submenu-lista">
    <a href="https://forms.gle/qZJS945CVCF6spgA9" target="_blank">➕ Cargar seguro nuevo</a>
    <a href="docs/declaracion_jurada.pdf" target="_blank">📄 Descargar declaración</a>
    <a href="docs/info_seguro.pdf" target="_blank">📘 Ver información</a>
  </div>
</div>

<div class="menu-seccion">
    <a href="https://drive.google.com/drive/folders/1jeKMSZhLfi_oS9Yz-YNg46qQ4Kw-la25?usp=drive_link" target="_blank" class="nav-item">
      📜 <span>REGLAMENTOS</span>
    </a>
  </div>

  <div class="menu-seccion">
    <a href="https://drive.google.com/drive/folders/1QCHBw0will7Lhi13W2hy9M5K74GP8JRE?usp=drive_link" target="_blank" class="nav-item">
      🚀 <span>PROYECTO 2026</span>
    </a>
  </div>

  <div class="menu-seccion">
    <a href="javascript:void(0)" class="nav-item" onclick="mostrarCopa()">
      🏆 <span>COPA OPEN FEDERAL</span>
    </a>
  </div>
</nav>
</aside>

<div class="zona-derecha" id="main-content">
  
  <header class="header-admin">
    <div class="logo">
      <img src="img/logo.png" alt="Logo LIFEPAR" class="logo-img" />
      <div class="texto-logo">
        <h1>LIFEPAR</h1>
        <span class="slogan">es una realidad</span>
      </div>
    </div>
    <nav>
      <ul class="nav-buttons">
        <li><a href="index.html" class="btn-pildora-nav">IR A LA WEB</a></li>
        <li><button onclick="logout()" class="btn-cerrar-sesion">CERRAR SESIÓN</button></li>
      </ul>
    </nav>
  </header>

  <div class="header-spacer"></div>

  <main class="contenedor-principal">
    <div class="bienvenida-seccion">
        <h2>Panel de Entrenadores <span class="frase-fina">Bienvenido a tu oficina virtual</span></h2>
 <div style="text-align: right; padding: 15px; font-family: 'Quicksand', sans-serif;">
    <span id="display-name" style="font-weight: bold; font-size: 1.2rem; color: #333;">Cargando...</span><br>
    <span id="display-email" style="font-size: 0.9rem; color: #666;"></span>
 </div>
</section>

<section id="contenedor-acciones-zonas" style="display: none; margin-top: 20px; width: 100%;">
            </section>
      
    <section class="box-oficina" id="seguros" style="display: none;">
        <h3>Gestión de Seguros</h3>
        <div class="lista-links">
            <a href="https://forms.gle/qZJS945CVCF6spgA9" target="_blank" class="btn-link-fino">➕ Cargar seguro nuevo</a>
            <a href="docs/declaracion_jurada.pdf" target="_blank" class="btn-link-fino">📄 Descargar declaración</a>
            <a href="docs/info_seguro.pdf" target="_blank" class="btn-link-fino">📘 Información general</a>
        </div>
    </section>

    <section class="box-oficina" id="copa-federal" style="display: none;">
        <h3>Open Copa Federal</h3>
        <div class="lista-links">
            <a href="#" target="_blank" class="btn-link-fino">📄 Ver PDF del evento</a>
            <a href="#" target="_blank" class="btn-link-fino">📝 Formulario inscripción</a>
        </div>
    </section>
    </main> 

    <footer class="footer-premium">
    <p>© 2026 <span class="brand">LIFEPAR</span> - Todos los derechos reservados</p>
    <div class="footer-contact">
        <a href="https://instagram.com/ligalifepar" target="_blank">📸 @ligalifepar</a>
        <a href="https://wa.me/541158512121" target="_blank">📱 11-5851-2121</a>
    </div>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDOwn0QlyqdU3fDBEsPFuvPMzs4ylqMuQ8",
    authDomain: "web-lifepar.firebaseapp.com",
    databaseURL: "https://web-lifepar-default-rtdb.firebaseio.com",
    projectId: "web-lifepar",
    storageBucket: "web-lifepar.firebasestorage.app",
    messagingSenderId: "140850288146",
    appId: "1:140850288146:web:fe1d35bac4c30c39b3aacb"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Exponemos la función al objeto window para que el iframe la vea
  window.registrarClubEnFirebase = async (emailKey, clubKey) => {
    const clubRef = ref(db, `CLUBES/${emailKey}/${clubKey}`);
    return await set(clubRef, {
      nombre: clubKey.replace(/_/g, ' '),
      estado: "pendiente",
      fecha: new Date().toLocaleDateString()
    });
  };

  window.obtenerClubesFirebase = async (emailKey) => {
    const { getDatabase, ref, get } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    const snapshot = await get(ref(db, `CLUBES/${emailKey}`));
    if (snapshot.exists()) {
        return snapshot.val(); // Retorna el objeto con todos los clubes del profe
    }
    return null;
};
  // Dentro del script type="module" del HTML principal
window.guardarPatinadorFirebase = async (numZona, datos) => {
    const { getDatabase, ref, push } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    
    // Creamos la ruta ZONAS/ZONA_1, ZONAS/ZONA_2, etc.
    const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
    
    // Usamos push para que cada patinador tenga un ID único y no se pisen
    return await push(zonaRef, {
        ...datos,
        fecha_registro: new Date().toISOString()
    });
};

// --- PUENTE DE ALTA PRIORIDAD PARA EL HIJO ---

window.obtenerPatinadoresPorClub = async (numZona, mailProfe) => {
    try {
        const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
        // Usamos la 'db' que ya inicializaste al principio del script
        const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
        const consulta = query(zonaRef, orderByChild("mailProfe"), equalTo(mailProfe));
        const snapshot = await get(consulta);
        
        return snapshot.exists() ? snapshot.val() : {};
    } catch (error) {
        console.error("Error en Puente Padre:", error);
        return null;
    }
};

// FUNCIÓN 2: Guarda el tilde de F2, F3 o F4 al instante
window.actualizarAsistencia = async (numZona, idPatinador, campoFecha, estado) => {
    const { getDatabase, ref, update } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
    const db = getDatabase();
    const updates = {};
    updates[`ZONAS/ZONA_${numZona}/${idPatinador}/${campoFecha}`] = estado;
    
    return update(ref(db), updates);
};

window.mostrarListadoAltas = async (numZona) => {
    const mailProfe = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
    const contenedor = document.getElementById('contenedor-acciones-zonas');
    
    // Configuración del Modal (Ventana Emergente)
    contenedor.style.display = 'flex';
    contenedor.style.position = 'fixed';
    contenedor.style.top = '0';
    contenedor.style.left = '0';
    contenedor.style.width = '100%';
    contenedor.style.height = '100%';
    contenedor.style.backgroundColor = 'rgba(0, 0, 0, 0.9)'; 
    contenedor.style.zIndex = '3000';
    contenedor.style.justifyContent = 'center';
    contenedor.style.alignItems = 'flex-start';
    contenedor.style.overflowY = 'auto';
    contenedor.style.padding = '20px 0';

    contenedor.innerHTML = '<p style="color:gold; text-align:center; margin-top: 50px; font-family:Quicksand;">⏳ Organizando Padrón Deportivo...</p>';

    try {
        const { ref, get, query, orderByChild, equalTo } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js");
        const zonaRef = ref(db, `ZONAS/ZONA_${numZona}`);
        
        let consulta;
        // LÓGICA ADMIN: Si el mail es el tuyo, trae todo.
        if (mailProfe === 'jose.gen86@gmail.com') { 
            consulta = zonaRef; 
        } else {
            consulta = query(zonaRef, orderByChild("mailProfe"), equalTo(mailProfe));
        }

        const snapshot = await get(consulta);

        if (!snapshot.exists()) {
            contenedor.innerHTML = `
                <div style="background:#111; padding:30px; border-radius:15px; border:2px solid gold; text-align:center; margin-top:50px; color:white; font-family:Quicksand;">
                    <p>No hay patinadores cargados en la Zona ${numZona}.</p>
                    <button onclick="document.getElementById('contenedor-acciones-zonas').style.display='none'" style="background:gold; border:none; padding:10px 20px; cursor:pointer; margin-top:20px; font-weight:bold; border-radius:5px;">CERRAR</button>
                </div>`;
            return;
        }

        let patinadores = [];
        snapshot.forEach((hijo) => {
            patinadores.push({ id: hijo.key, ...hijo.val() });
        });

        // ORDEN DEPORTIVO
        patinadores.sort((a, b) => {
            if (a.club !== b.club) return a.club.localeCompare(b.club);
            if (a.divisional !== b.divisional) return a.divisional.localeCompare(b.divisional);
            return a.apellido.localeCompare(b.apellido);
        });

        let html = `
        <style>
            .modal-altas-cuerpo { background: #0a0a0a; width: 95%; max-width: 1100px; border: 2px solid gold; border-radius: 15px; padding: 20px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); margin-top:20px; }
            .buscador-contenedor { position: sticky; top: -20px; background: #0a0a0a; padding: 15px 0; z-index: 10; border-bottom: 1px solid #333; margin-bottom: 20px; }
            .input-busqueda { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #444; background: #111; color: white; font-family: 'Quicksand'; font-size: 1.1rem; }
            .grid-altas { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
            .card-alta { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; border-left: 5px solid gold; display: flex; flex-direction: column; align-items: center; text-align: center; }
            .btn-check { background: #222; border: 1px solid #444; color: #777; padding: 10px; border-radius: 8px; cursor: pointer; flex: 1; margin: 0 3px; font-weight: bold; font-size: 0.85rem; }
            .btn-check.activo { background: #28a745; color: white; border-color: #28a745; }
            .btn-check:disabled { opacity: 0.3; cursor: not-allowed; }
            .btn-cerrar-modal { position: absolute; top: 15px; right: 20px; background: none; border: none; color: gold; font-size: 1.8rem; cursor: pointer; font-family: 'Anton'; z-index: 15; }
        </style>

        <div class="modal-altas-cuerpo">
            <button class="btn-cerrar-modal" onclick="document.getElementById('contenedor-acciones-zonas').style.display='none'">×</button>
            
            <div class="buscador-contenedor">
                <input type="text" id="inputFiltroPatinador" class="input-busqueda" placeholder="🔍 Escribí nombre, apellido o club para buscar..." onkeyup="window.filtrarTarjetas()">
            </div>

            <h3 style="color:gold; font-family:'Anton'; text-align:center; margin-bottom:20px; text-transform: uppercase; letter-spacing:1px;">PADRÓN ZONA ${numZona}</h3>
            
            <div class="grid-altas" id="grillaPatinadores">`;

        patinadores.forEach((p) => {
            // Si el mail es el tuyo, NO se bloquea nada (bloqueado = false)
            const bloqueado = (mailProfe !== 'jose.gen86@gmail.com');

            html += `
                <div class="card-alta" data-busqueda="${p.apellido.toLowerCase()} ${p.nombre.toLowerCase()} ${p.club.toLowerCase()}">
                    <h3 style="color: #fff; font-size: 1.1rem; margin: 0; font-family: 'Quicksand'; font-weight: 600; text-transform: uppercase;">${p.apellido}, ${p.nombre}</h3>
                    
                    <div style="display: flex; gap: 8px; margin: 5px 0; font-family: 'Quicksand'; font-size: 0.85rem; justify-content: center; width:100%;">
                        <span style="color: gold; font-weight: bold;">${p.divisional}</span>
                        <span style="color: #bbb;">${p.categoria}</span>
                        <span style="color: #888;">${p.edadDeportiva || ''}</span>
                    </div>

                    <p style="color: #555; font-size: 0.75rem; margin-bottom: 10px; font-style: italic; font-family: 'Quicksand';">${p.club}</p>

                    <div class="controles-f" style="width: 100%; display: flex; gap: 2px;">
                        <button class="btn-check ${p.asisteF2 ? 'activo' : ''}" ${(p.asisteF2 && bloqueado) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','asisteF2',this)">F2</button>
                        <button class="btn-check ${p.asisteF3 ? 'activo' : ''}" ${(p.asisteF3 && bloqueado) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','asisteF3',this)">F3</button>
                        <button class="btn-check ${p.asisteF4 ? 'activo' : ''}" ${(p.asisteF4 && bloqueado) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','asisteF4',this)">F4</button>
                    </div>
                </div>`;
        });

        html += `</div>
            <button onclick="document.getElementById('contenedor-acciones-zonas').style.display='none'" style="margin:40px 0 10px 0; width:100%; background:gold; border:none; padding:15px; font-weight:bold; cursor:pointer; border-radius:10px; color:black; font-family:'Quicksand';">CERRAR PADRÓN</button>
        </div>`;
        
        contenedor.innerHTML = html;
    } catch (e) {
        console.error(e);
        contenedor.innerHTML = '<p style="color:red; text-align:center;">Error de conexión.</p>';
    }
};

// --- FUNCIÓN DE FILTRADO (LA QUE FALTABA) ---
window.filtrarTarjetas = () => {
    const texto = document.getElementById('inputFiltroPatinador').value.toLowerCase();
    const tarjetas = document.querySelectorAll('.card-alta');

    tarjetas.forEach(tarjeta => {
        const busqueda = tarjeta.getAttribute('data-busqueda');
        if (busqueda.includes(texto)) {
            tarjeta.style.display = 'flex';
        } else {
            tarjeta.style.display = 'none';
        }
    });
};

window.toggleBotonAsistencia = async (numZona, id, campo, boton) => {
    const nuevoEstado = !boton.classList.contains('activo');
    try {
        await window.actualizarAsistencia(numZona, id, campo, nuevoEstado);
        boton.classList.toggle('activo');
    } catch (e) {
        alert("Error al guardar");
    }
};
</script>
<script src="admin.js"></script>
</body>
</html>
