<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="admin.css"> <link href="https://fonts.googleapis.com/css2?family=Anton&family=Quicksand:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos m√≠nimos para que el iframe se vea integrado */
        body { background: transparent; padding: 10px; color: white; overflow-y: auto; }
        .menu-zona { display: block !important; margin: auto; max-width: 1000px; }
        .btn-accion { width: 100%; margin: 10px 0; cursor: pointer; }
        select { background: #333; color: white; border-radius: 5px; padding: 5px; width: 100%; }
    </style>
</head>
<body>

   <div class="menu-zona">
    <h4 id="dinamico-titulo">Acciones para Zona ...</h4>
    
    <div style="margin-bottom: 15px; padding: 10px; border: 1px solid #444; border-radius: 8px; background: rgba(0,0,0,0.3);">
        <label style="color: gold; font-size: 0.8rem; display: block; margin-bottom: 5px; font-family: 'Quicksand';">SELECCIONAR FECHA DE TRABAJO:</label>
        <select id="selectorFechaActiva" style="width: 100%; padding: 8px; background: #111; color: white; border: 1px solid gold; border-radius: 5px; font-family: 'Quicksand';">
            <option value="1">Padr√≥n Base (Solo Carga)</option>
            <option value="2">Fecha 2</option>
            <option value="3">Fecha 3</option>
            <option value="4">Fecha 4</option>
        </select>
    </div>

    <ul>
        <li>üìù <button onclick="ejecutarCargaConFecha()" class="btn-accion">Cargar patinadoras/es</button></li>
        <li>‚úÖ <button onclick="window.mostrarListadoAltas(window.zonaActivaNum)" class="btn-accion">Altas pr√≥xima fecha</button></li>
        <li>üè¢ <button onclick="ejecutarModalClubes()" class="btn-accion" style="background: rgba(255,215,0,0.1); border: 1px dashed gold;">Asociar nuevo Club</button></li>
    </ul>
</div>

<div id="contenedor-formulario-dinamico" style="display: none; margin-top: 20px;"></div>

    <div id="ModalClub" style="display:none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); padding-top: 100px;">
    <div style="background: #1a1a1a; margin: auto; padding: 20px; border: 1px solid gold; border-radius: 15px; width: 80%; max-width: 400px; text-align: center; color: white;">
        <h3 style="color: gold; font-family: 'Anton', sans-serif;">ASOCIAR NUEVO CLUB</h3>
        <p style="font-size: 0.8rem; margin-bottom: 15px;">Escrib√≠ el nombre del club para solicitar el alta:</p>
        
        <input type="text" id="nuevo-club-nombre" placeholder="NOMBRE DEL CLUB" class="input-registro" style="width: 100%; margin-bottom: 20px; text-transform: uppercase;">
        
        <div style="display: flex; gap: 10px;">
            <button onclick="window.guardarNuevoClub()" style="flex: 1; padding: 10px; background: gold; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ENVIAR</button> 
            <button onclick="window.cerrarModalClubes()" style="flex: 1; padding: 10px; background: #444; color: white; border: none; border-radius: 5px; cursor: pointer;">CANCELAR</button>
        </div>
    </div>
</div>

<script src="acciones_zonas.js?v=1.2"></script>

 <script>
    // 1. Detecci√≥n de zona (Aseguramos que existan antes de usarlas)
    const urlParams = new URLSearchParams(window.location.search);
    const zonaSaca = urlParams.get('zona'); 
    
    // Las guardamos en window para que el .js las vea
    window.zonaActivaNum = zonaSaca; 
    window.zonaActiva = "ZONA " + zonaSaca; 

    // Seteamos el t√≠tulo
    const titulo = document.getElementById('dinamico-titulo');
    if (titulo) titulo.innerText = `Acciones para Zona ${zonaSaca}`;

    // 2. Funciones Puente
    function ejecutarCarga() {
        // Verificamos que zonaActivaNum tenga algo
        if (!window.zonaActivaNum) {
            console.error("Error: No se detect√≥ el n√∫mero de zona en la URL");
            return;
        }
        
        console.log("Cargando para Zona: " + window.zonaActivaNum);
        
        if (typeof abrirFormularioCarga === 'function') {
            abrirFormularioCarga(window.zonaActivaNum); 
        } else {
            console.error("La funci√≥n abrirFormularioCarga no est√° definida en acciones_zonas.js");
        }
    }

    function ejecutarVerDatos() {
        alert("Visualizando datos de " + window.zonaActiva);
    }


  // Esta funci√≥n le grita al padre lo que tiene que guardar
  async function enviarDatosAlPadre(emailKey, clubKey) {
    if (parent && parent.registrarClubEnFirebase) {
      await parent.registrarClubEnFirebase(emailKey, clubKey);
    } else {
      throw new Error("Conexi√≥n no lista");
    }
  }

function ejecutarModalClubes() {
    if (typeof window.abrirModalClubes === 'function') {
        window.abrirModalClubes();
    } else {
        alert("La funci√≥n de clubes todav√≠a se est√° cargando. Esper√° un momento.");
    }
}

// EL HIJO DIBUJA TODO
window.mostrarListadoAltas = async (numZona) => {
    const mailProfe = sessionStorage.getItem('userEmail') || localStorage.getItem('userEmail');
    
    // CREAMOS EL CONTENEDOR DENTRO DEL HIJO PARA QUE NO FLOTE EN EL PADRE
    let contenedor = document.getElementById('contenedor-tarjetas-hijo');
    if(!contenedor){
        contenedor = document.createElement('div');
        contenedor.id = 'contenedor-tarjetas-hijo';
        document.body.appendChild(contenedor);
    }

    // Mantenemos tus estilos EXACTOS
    contenedor.style.display = 'flex';
    contenedor.style.position = 'fixed';
    contenedor.style.top = '0';
    contenedor.style.left = '0';
    contenedor.style.width = '100%';
    contenedor.style.height = '100%';
    contenedor.style.backgroundColor = 'rgba(0, 0, 0, 0.95)'; 
    contenedor.style.zIndex = '5000';
    contenedor.style.justifyContent = 'center';
    contenedor.style.alignItems = 'flex-start';
    contenedor.style.overflowY = 'auto';
    contenedor.style.padding = '20px 0';

    contenedor.innerHTML = '<p style="color:gold; text-align:center; margin-top: 50px;">‚è≥ Organizando Padr√≥n...</p>';

    try {
        // EL PUENTE: Le pedimos los datos al Padre
        const snapshot = await window.parent.obtenerDatosFirebase(numZona, mailProfe);

        if (!snapshot.exists()) {
            contenedor.innerHTML = `<button onclick="document.getElementById('contenedor-tarjetas-hijo').style.display='none'" style="background:gold; border:none; padding:15px; margin-top:50px; cursor:pointer; font-weight:bold;">CERRAR</button>`;
            return;
        }

        let patinadores = [];
        snapshot.forEach((hijo) => { patinadores.push({ id: hijo.key, ...hijo.val() }); });
        patinadores.sort((a, b) => a.apellido.localeCompare(b.apellido));

        let html = `
        <style>
            .modal-altas-cuerpo { background: #0a0a0a; width: 95%; max-width: 1100px; border: 2px solid gold; border-radius: 15px; padding: 25px; position: relative; margin: 20px auto; box-shadow: 0 0 50px #000; }
            .btn-x-cerrar { position: absolute; top: -15px; right: -15px; background: gold; color: black; border: 2px solid black; width: 35px; height: 35px; border-radius: 50%; font-size: 20px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 6000; }
            .buscador-fijo { position: sticky; top: -25px; background: #0a0a0a; padding: 15px 0; z-index: 100; border-bottom: 1px solid #333; margin-bottom: 20px; }
            .grid-altas { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; width: 100%; }
            .card-alta { background: #151515; border-radius: 10px; padding: 15px; border-left: 5px solid gold; display: flex !important; flex-direction: column; align-items: center; min-height: 200px; width: 100%; box-sizing: border-box; }
            .info-p { margin: 0; width: 100%; text-align: center; }
            .nombre-p { color: white; font-family: 'Quicksand'; font-size: 0.95rem; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
            .datos-p { color: #888; font-size: 0.75rem; margin-bottom: 10px; line-height: 1.2; }
            .seccion-t { font-size: 0.65rem; color: #444; font-weight: bold; text-transform: uppercase; margin-top: 10px; width: 100%; border-top: 1px solid #222; padding-top: 5px; }
            .fila-btns { display: flex; gap: 4px; width: 100%; margin-top: 5px; }
            .btn-f { background: #222; border: 1px solid #333; color: #666; padding: 8px 2px; border-radius: 5px; cursor: pointer; flex: 1; font-weight: bold; font-size: 0.75rem; transition: 0.2s; }
            .btn-f.activo { background: #28a745 !important; color: white !important; border-color: #28a745 !important; }
            .btn-f:disabled { opacity: 0.7; cursor: not-allowed; }
        </style>

        <div class="modal-altas-cuerpo">
            <button class="btn-x-cerrar" onclick="document.getElementById('contenedor-tarjetas-hijo').style.display='none'">‚úï</button>
            <div class="buscador-fijo">
                <input type="text" id="inputFiltroPatinador" style="width:100%; padding:15px; border-radius:10px; border: 1px solid #444; background:#111; color:white; font-family:Quicksand; font-size: 1rem;" placeholder="üîç Buscar..." onkeyup="window.filtrarTarjetas()">
            </div>
            <h3 style="color:gold; text-align:center; font-family:'Anton'; margin-bottom:20px; text-transform: uppercase;">PADR√ìN ZONA ${numZona}</h3>
            <div class="grid-altas" id="grillaPatinadores">`;

        patinadores.forEach((p) => {
            const esAdmin = (mailProfe === 'test@test.com');
            const tieneAnual = p.seguroAnual === true;
            html += `
                <div class="card-alta" data-busqueda="${p.apellido.toLowerCase()} ${p.nombre.toLowerCase()} ${p.club.toLowerCase()}">
                    <div class="info-p">
                        <div class="nombre-p">${p.apellido}, ${p.nombre}</div>
                        <div class="datos-p">${p.club} | ${p.divisional} ${p.categoria}<br>${p.edadDeportiva || ''}</div>
                    </div>
                    <div class="seccion-t">Seguros</div>
                    <div class="fila-btns">
                        <button class="btn-f ${tieneAnual ? 'activo' : ''}" ${(tieneAnual && !esAdmin) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','seguroAnual',this)">S. ANUAL</button>
                        <button class="btn-f ${p.seguroF2 ? 'activo' : ''}" ${((tieneAnual || p.seguroF2) && !esAdmin) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','seguroF2',this)">S. DIARIO</button>
                    </div>
                    <div class="seccion-t">Asistencias</div>
                    <div class="fila-btns">
                        <button class="btn-f ${p.asisteF2 ? 'activo' : ''}" ${(p.asisteF2 && !esAdmin) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','asisteF2',this)">F2</button>
                        <button class="btn-f ${p.asisteF3 ? 'activo' : ''}" ${(p.asisteF3 && !esAdmin) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','asisteF3',this)">F3</button>
                        <button class="btn-f ${p.asisteF4 ? 'activo' : ''}" ${(p.asisteF4 && !esAdmin) ? 'disabled' : ''} onclick="window.toggleBotonAsistencia('${numZona}','${p.id}','asisteF4',this)">F4</button>
                    </div>
                </div>`;
        });

        html += `</div>
            <button onclick="document.getElementById('contenedor-tarjetas-hijo').style.display='none'" style="margin-top:30px; width:100%; background:gold; border:none; padding:15px; font-weight:bold; cursor:pointer; border-radius:10px; color:black; font-family:Quicksand; font-size:1.1rem;">CERRAR PADR√ìN</button>
        </div>`;
        contenedor.innerHTML = html;
    } catch (e) { console.error(e); }
};

window.filtrarTarjetas = () => {
    const texto = document.getElementById('inputFiltroPatinador').value.toLowerCase();
    const tarjetas = document.querySelectorAll('.card-alta');
    tarjetas.forEach(t => {
        t.style.display = t.getAttribute('data-busqueda').includes(texto) ? 'flex' : 'none';
    });
};

window.toggleBotonAsistencia = async (numZona, id, campo, boton) => {
    const nuevoEstado = !boton.classList.contains('activo');
    try {
        // LE AVISAMOS AL PADRE QUE GRABE
        await window.parent.actualizarAsistencia(numZona, id, campo, nuevoEstado);
        boton.classList.toggle('activo');
    } catch (e) { alert("Error al guardar"); }
};
</script>
</body>
</html>